<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometric Range - V40 Neural Rig</title>
    <style>
        /* ALL V39 STYLES (PRIME FOUNDATION, PAUSE MENU, HUD, INVENTORY) ARE UNTOUCHED */
        /* ... [Your 200+ lines of CSS here] ... */
        
        /* ADDING ONLY THE NEURAL OVERLAYS TO THE END OF CSS */
        #boot-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: black; z-index: 90; pointer-events: none; opacity: 1; transition: opacity 5s ease; }
        #neural-pairing-ui {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 95; background: rgba(5,5,5,0.98); padding: 50px; width: 320px; 
            border: 1px solid #00f2ff; color: white; text-align: center; display: none; opacity: 0; transition: opacity 0.5s;
        }
        #halo-visor { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 80; opacity: 0; transition: opacity 2s; }
        .arc-ui { position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%); width: 750px; height: 120px; border-top: 2px solid rgba(0, 242, 255, 0.4); border-radius: 50% 50% 0 0; }
    </style>
</head>
<body>
    <div id="boot-overlay"></div>
    <div id="halo-visor"><div class="arc-ui"></div></div>
    <div id="neural-pairing-ui">
        <div style="color:#00f2ff; letter-spacing: 5px; margin-bottom: 20px;">ROBOTIC_LINK</div>
        <input type="file" id="glb-upload" accept=".glb" style="display:none;">
        <button onclick="document.getElementById('glb-upload').click()" style="background:transparent; border:1px solid #00f2ff; color:#00f2ff; padding:15px; width:100%; cursor:pointer; font-weight:bold;">UPLOAD_GLB_CORE</button>
        <div id="boot-msg" style="margin-top:20px; font-size:9px; color:#444;">SYSTEM_IDLE...</div>
    </div>

    <script type="module">
        /* ============================================================
           V39 PROTECTED CORE (50KB SCRIPT)
           ============================================================ */
        // [YOUR ENTIRE V39 SCRIPT GOES HERE - DO NOT REMOVE]
        // Including: init(), animate(), Building Generators, 
        // Audio Systems, and Inventory Logic.
        
        // --- THE FOLLOWING IS THE NEW APPENDED LOGIC ---

        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let robotCore = null;
        let limbBoxes = [];
        let visorMeshes = [];
        const RIG_HEIGHT = 7.0;

        // Hooking into your existing 'start-btn'
        const startBtn = document.getElementById('start-btn');
        const pairUI = document.getElementById('neural-pairing-ui');
        const glbUp = document.getElementById('glb-upload');

        startBtn.addEventListener('click', () => {
            // Wait for your original click logic to finish, then show Neural UI
            setTimeout(() => {
                pairUI.style.display = 'block';
                setTimeout(() => pairUI.style.opacity = '1', 50);
            }, 100);
        });

        glbUp.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('boot-msg').innerText = "CALIBRATING_SYNA_LINK...";
            document.getElementById('boot-overlay').style.opacity = "0"; // Trigger 5s reveal

            new GLTFLoader().load(URL.createObjectURL(file), (gltf) => {
                robotCore = gltf.scene;
                
                // Scale to V39 Height
                const b3 = new THREE.Box3().setFromObject(robotCore);
                const scale = RIG_HEIGHT / b3.getSize(new THREE.Vector3()).y;
                robotCore.scale.set(scale, scale, scale);

                robotCore.traverse(child => {
                    if (child.isMesh) {
                        // RIGGING: Separate limb hitboxes
                        limbBoxes.push({ mesh: child, box: new THREE.Box3() });
                        // VISOR: Detect head for culling
                        if (child.name.toLowerCase().match(/head|face|eye|visor/)) visorMeshes.push(child);
                    }
                });

                scene.add(robotCore); // Injected into your global 'scene'
                
                // Begin 5-second Cold Boot sequence
                setTimeout(() => {
                    pairUI.style.opacity = "0";
                    document.getElementById('halo-visor').style.opacity = "1";
                    setTimeout(() => pairUI.style.display = 'none', 1000);
                }, 5000);
            });
        };

        // NEW NEURAL LOOP: Runs in parallel to your V39 animate loop
        function neuralRigLoop() {
            requestAnimationFrame(neuralRigLoop);
            if (robotCore && controls.isLocked) {
                // 1. Position robot at V39 camera location
                robotCore.position.copy(cameraGroup.position);
                robotCore.position.y -= 5; // Offset to keep feet on your stony floor
                
                // 2. Rotate robot to match V39 camera look direction
                const camEuler = new THREE.Euler().setFromQuaternion(camera.quaternion, 'YXZ');
                robotCore.rotation.y = camEuler.y + Math.PI;

                // 3. Update individual limb hitboxes for physical accuracy
                limbBoxes.forEach(item => item.box.setFromObject(item.mesh));

                // 4. Hide head meshes so they don't block the V39 camera view
                visorMeshes.forEach(m => m.visible = false);
            }
        }
        neuralRigLoop();

    </script>
</body>
</html>
