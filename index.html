<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.A.N.U.L. PROTOCOL - V39.2</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: monospace; background: #111; }
        canvas { display: block; }
        #loading-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #eee; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #neural-link-ui { position: fixed; top: 20px; right: 20px; z-index: 1000; background: rgba(0,0,0,0.9); padding: 15px; border: 1px solid #ff4b2b; color: white; border-radius: 4px; }
        #instructions { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; background: rgba(255,255,255,0.9); z-index: 20; }
        .start-prompt { font-weight: bold; color: #ff4b2b; cursor: pointer; letter-spacing: 5px; margin-top: 20px; }
        #hud { position: fixed; bottom: 20px; left: 20px; color: white; z-index: 10; }
        .bar { width: 200px; height: 10px; background: #333; margin: 5px 0; border-radius: 5px; overflow: hidden; }
        #stamina-fill { width: 100%; height: 100%; background: #6dd5ed; transition: width 0.1s; }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>
    <div id="loading-screen"><h1>INITIALIZING NEURAL LINK...</h1></div>

    <div id="neural-link-ui">
        <div style="color: #ff4b2b; font-weight: bold; margin-bottom: 5px;">M.A.N.U.L. UPLOAD</div>
        <input type="file" id="robot-file" accept=".glb">
    </div>

    <div id="instructions">
        <h1>MEGA DISTRICT</h1>
        <p>WASD: MOVE | SHIFT: SPRINT | V: TOGGLE VIEW</p>
        <div class="start-prompt" id="start-btn">CLICK TO ENGAGE</div>
    </div>

    <div id="hud">
        STAMINA
        <div class="bar"><div id="stamina-fill"></div></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let scene, camera, renderer, controls, cameraGroup, manulModel;
        let moveF = false, moveB = false, moveL = false, moveR = false, isSprinting = false;
        let velocity = new THREE.Vector3();
        let isThirdPerson = false;
        let stamina = 100;

        init();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xcccccc);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            cameraGroup = new THREE.Group();
            cameraGroup.add(camera);
            scene.add(cameraGroup);

            // Default Camera position (Slightly up)
            cameraGroup.position.set(0, 5, 0);

            const light = new THREE.HemisphereLight(0xffffff, 0x444444, 2);
            scene.add(light);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new PointerLockControls(cameraGroup, document.body);
            document.getElementById('start-btn').onclick = () => controls.lock();
            
            controls.addEventListener('lock', () => {
                document.getElementById('instructions').style.display = 'none';
            });
            controls.addEventListener('unlock', () => {
                document.getElementById('instructions').style.display = 'flex';
            });

            // Floor
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshPhongMaterial({ color: 0x999999 }));
            floor.rotation.x = -Math.PI/2;
            scene.add(floor);

            // FILE UPLOAD LOGIC
            const loader = new GLTFLoader();
            document.getElementById('robot-file').onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                loader.load(URL.createObjectURL(file), (gltf) => {
                    if (manulModel) cameraGroup.remove(manulModel);
                    manulModel = gltf.scene;
                    
                    // Center and scale the model
                    manulModel.scale.set(1.5, 1.5, 1.5);
                    manulModel.position.set(0, -2.5, 0); // Position at feet level
                    manulModel.rotation.y = Math.PI; // Face forward
                    
                    cameraGroup.add(manulModel);
                    document.getElementById('neural-link-ui').style.opacity = '0.3';
                    console.log("M.A.N.U.L. Online");
                });
            };

            window.addEventListener('keydown', (e) => {
                if(e.code === 'KeyW') moveF = true;
                if(e.code === 'KeyS') moveB = true;
                if(e.code === 'KeyA') moveL = true;
                if(e.code === 'KeyD') moveR = true;
                if(e.code === 'ShiftLeft') isSprinting = true;
                if(e.code === 'KeyV') toggleView();
            });

            window.addEventListener('keyup', (e) => {
                if(e.code === 'KeyW') moveF = false;
                if(e.code === 'KeyS') moveB = false;
                if(e.code === 'KeyA') moveL = false;
                if(e.code === 'KeyD') moveR = false;
                if(e.code === 'ShiftLeft') isSprinting = false;
            });

            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('instructions').style.display = 'flex';
            }, 1000);

            animate();
        }

        function toggleView() {
            isThirdPerson = !isThirdPerson;
            if (isThirdPerson) {
                camera.position.set(0, 3, 7); // Move camera back and up
                camera.lookAt(0, 0, -2);
            } else {
                camera.position.set(0, 0, 0); // Return to eyes
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (controls.isLocked) {
                const delta = 0.15;
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;

                const speed = (isSprinting && stamina > 0) ? 1.2 : 0.6;
                if (moveF) velocity.z -= speed;
                if (moveB) velocity.z += speed;
                if (moveL) velocity.x -= speed;
                if (moveR) velocity.x += speed;

                controls.moveForward(-velocity.z * 0.1);
                controls.moveRight(velocity.x * 0.1);

                if (isSprinting && (moveF || moveB || moveL || moveR)) {
                    stamina = Math.max(0, stamina - 0.5);
                } else {
                    stamina = Math.min(100, stamina + 0.2);
                }
                document.getElementById('stamina-fill').style.width = stamina + '%';
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
