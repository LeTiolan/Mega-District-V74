<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometric Range - V34.3 Minimalist Expansion</title>
    <style>
        /* ============================================================
           PRIME FOUNDATION STYLES (UNTOUCHED)
           ============================================================ */
        body { margin: 0; overflow: hidden; font-family: 'Inter', 'Segoe UI', 'Courier New', monospace; background-color: #f4f4f4; }
        canvas { display: block; }
        
        /* ============================================================
           MINIMALIST LOADING SCREEN (REFINED)
           ============================================================ */
        #loading-screen { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #f4f4f4; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 100; 
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .loader-title { 
            font-size: 4rem; 
            letter-spacing: 25px; 
            font-weight: 100; 
            color: #111; 
            margin-bottom: 80px; 
            text-transform: uppercase; 
            opacity: 0.8;
        }

        .loader-container { 
            width: 300px; 
            height: 1px; /* Thinner line for minimalism */
            background: rgba(0,0,0,0.05); 
            overflow: hidden; 
        }

        #loader-fill { 
            width: 0%; 
            height: 100%; 
            background: #111; /* Neutral color for minimalist feel */
            transition: width 0.1s linear; 
        }

        /* ============================================================
           MINIMALIST PAUSE & SETTINGS UI (REFINED)
           ============================================================ */
        #instructions {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: #111; background: rgba(255, 255, 255, 0.92);
            backdrop-filter: grayscale(1) brightness(1.1); /* Subtle artistic filter */
            -webkit-backdrop-filter: grayscale(1) brightness(1.1);
            user-select: none; z-index: 20; transition: opacity 0.6s ease;
        }

        .menu-wrapper {
            width: 500px; display: flex; flex-direction: column; align-items: center;
        }

        .title-container { 
            height: 4rem; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-bottom: 40px; 
        }

        .title-init { 
            font-size: 2.2rem; 
            margin: 0; 
            letter-spacing: 12px; 
            font-weight: 200; 
            text-transform: uppercase; 
            color: #111;
            white-space: nowrap; 
        }

        /* Minimalist Type Animation: No border-right, just opacity fade-in */
        .animate-type { 
            animation: fadeInSimple 2s ease-out forwards; 
        }

        @keyframes fadeInSimple { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .tab-container {
            display: flex; gap: 50px; margin-bottom: 40px; width: 100%; justify-content: center;
        }

        .tab-btn {
            font-size: 0.7rem; letter-spacing: 5px; padding-bottom: 8px; cursor: pointer; opacity: 0.3; transition: 0.4s; text-transform: uppercase;
        }

        .tab-btn.active { opacity: 1; border-bottom: 1px solid #111; color: #111; }

        #keybind-settings { display: none; width: 100%; flex-direction: column; gap: 8px; }
        #main-manual { display: flex; flex-direction: column; align-items: center; }

        .key-row {
            display: flex; justify-content: space-between; width: 100%; padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.03); align-items: center;
        }

        .key-label { font-size: 0.65rem; letter-spacing: 3px; text-transform: uppercase; color: #999; }
        
        .key-cap {
            color: #111; padding: 4px 10px; min-width: 60px; text-align: right;
            font-family: 'Courier New', monospace; font-size: 0.7rem; cursor: pointer; transition: 0.2s;
        }

        .key-cap.listening { color: #ff4b2b; font-weight: bold; }

        /* HUD & Overlay Persistence */
        #instructions p { font-size: 0.7rem; margin: 10px 0; letter-spacing: 3px; color: #888; opacity: 0; transition: opacity 0.8s ease; text-transform: uppercase; }
        .show-p { opacity: 1 !important; }
        
        .start-prompt { 
            margin-top: 50px !important; 
            font-weight: 300 !important; 
            color: #111 !important; 
            cursor: pointer; 
            letter-spacing: 8px; 
            transition: opacity 0.3s ease; 
        }
        .start-prompt:hover { opacity: 0.5; }

        #hud-container { position: absolute; bottom: 40px; left: 40px; display: flex; flex-direction: column; gap: 12px; z-index: 10; }
        .stat-wrapper { background: none; padding: 0; border: none; }
        .bar-container { width: 180px; height: 2px; background: rgba(0, 0, 0, 0.05); margin-top: 8px; }
        .bar-fill { width: 100%; height: 100%; transition: width 0.4s ease; }
        #cd-fill { background: #111; }
        #health-fill { background: #111; opacity: 0.6; }
        #stamina-fill { background: #111; opacity: 0.3; }
        .stat-label { color: #111; font-size: 8px; letter-spacing: 2px; text-transform: uppercase; }

        /* Unchanged System Overlays */
        #vignette { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-shadow: inset 0 0 100px rgba(0,0,0,0.1); pointer-events: none; z-index: 5; }
        #blur-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 6; opacity: 0; transition: opacity 0.2s ease; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; margin-left: -2px; margin-top: -2px; background: #111; border-radius: 50%; pointer-events: none; z-index: 10; opacity: 0.4; }
        
        /* Inventory Persistence (Minimalized) */
        #inventory-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); z-index: 30; opacity: 0; transition: opacity 0.4s ease; }
        .inventory-window { width: 800px; height: 500px; display: flex; gap: 40px; color: #111; }
        .inv-header { font-size: 1.5rem; letter-spacing: 15px; font-weight: 100; text-transform: uppercase; margin-bottom: 40px; }
        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .inv-slot { aspect-ratio: 1/1; border: 1px solid rgba(0,0,0,0.05); transition: 0.3s; cursor: pointer; }
        .inv-slot:hover, .inv-slot.active { border-color: #111; background: rgba(0,0,0,0.02); }
        .inv-right { flex: 0.7; padding-top: 60px; }
        #inv-item-name { font-size: 0.9rem; letter-spacing: 4px; font-weight: 600; margin-bottom: 15px; text-transform: uppercase; }
        #inv-item-desc { font-size: 0.7rem; line-height: 2; color: #777; text-transform: uppercase; letter-spacing: 1px; }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>
    <div id="loading-screen">
        <div class="loader-title">INIT</div>
        <div class="loader-container"><div id="loader-fill"></div></div>
    </div>

    <div id="vignette"></div>
    <div id="blur-overlay"></div>
    <div id="crosshair"></div>
    
    <div id="instructions">
        <div class="menu-wrapper">
            <div class="title-container">
                <h1 id="menu-title" class="title-init">MEGA DISTRICT</h1>
            </div>

            <div class="tab-container">
                <div class="tab-btn active" id="tab-manual">Manual</div>
                <div class="tab-btn" id="tab-keybinds">Keybinds</div>
            </div>
            
            <div id="main-manual">
                <p>WASD — Navigation</p>
                <p>Shift — Impulse</p>
                <p>Q — Displacement</p>
                <p>Space — Ascent</p>
                <p>Tab — Manifest</p>
                <p class="start-prompt" id="start-btn">BEGIN_SESSION</p>
            </div>

            <div id="keybind-settings">
                </div>
        </div>
    </div>

    <div id="hud-container">
        <div class="stat-wrapper">
            <div class="stat-label">Kinetic</div>
            <div class="bar-container"><div id="cd-fill" class="bar-fill"></div></div>
        </div>
        <div class="stat-wrapper">
            <div class="stat-label">Integrity</div>
            <div class="bar-container"><div id="health-fill" class="bar-fill"></div></div>
        </div>
        <div class="stat-wrapper">
            <div class="stat-label">Reserve</div>
            <div class="bar-container"><div id="stamina-fill" class="bar-fill"></div></div>
        </div>
    </div>

    <div id="inventory-overlay">
        <div class="inventory-window">
            <div style="flex: 1.2; display: flex; flex-direction: column;">
                <div class="inv-header">CARGO</div>
                <div class="inv-grid" id="inv-grid-container"></div>
            </div>
            <div class="inv-right">
                <div id="inv-item-name">NULL</div>
                <div id="inv-item-desc">Awaiting selection.</div>
                <div id="inv-close-btn" style="margin-top: 40px; font-size: 0.6rem; letter-spacing: 4px; cursor: pointer; opacity: 0.4;">[ EXIT ]</div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        /* THE REMAINDER OF THE SCRIPT (INIT, ANIMATE, PHYSICS, SOUNDS) 
           REMAINS IDENTICAL TO THE PRIME FOUNDATION (V34) 
           FOR ARCHITECTURAL INTEGRITY. 
        */

        let camera, scene, renderer, controls, cameraGroup;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, canJump = false, isRunning = false;
        let velocity = new THREE.Vector3(), direction = new THREE.Vector3();
        let prevTime = performance.now();
        let bobTimer = 0;
        let health = 100, stamina = 100;
        let leftUpper, rightUpper, leftFore, rightFore;
        const collidableBoxes = []; 
        const playerSize = 0.7;
        let isInventoryOpen = false;

        let playMenuClick = () => {};
        let playHoverSound = () => {};

        let binds = {
            forward: 'KeyW',
            backward: 'KeyS',
            left: 'KeyA',
            right: 'KeyD',
            sprint: 'ShiftLeft',
            jump: 'Space',
            slide: 'KeyQ',
            inventory: 'Tab'
        };
        let isListeningForKey = null;

        let isSliding = false;
        let slideTimer = 0;
        let slideCooldown = 0;
        const slideMaxDuration = 1.0; 
        const slideMaxCooldown = 5.0; 
        const slideSpeedMultiplier = 3.5;
        const baseFOV = 75;
        const warpFOV = 95;
        const blurElem = document.getElementById('blur-overlay');
        const cdFill = document.getElementById('cd-fill');

        function startLoading() {
            const fill = document.getElementById('loader-fill');
            const screen = document.getElementById('loading-screen');
            const menu = document.getElementById('instructions');
            const title = document.getElementById('menu-title');
            const paragraphs = document.querySelectorAll('#main-manual p');
            let progress = 0;

            const interval = setInterval(() => {
                progress += Math.random() * 8;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    menu.style.display = 'flex';
                    setTimeout(() => {
                        menu.style.opacity = '1';
                        screen.style.opacity = '0';
                        title.classList.add('animate-type');
                        setTimeout(() => {
                            paragraphs.forEach((p, i) => {
                                setTimeout(() => p.classList.add('show-p'), i * 150);
                            });
                        }, 500);
                        setTimeout(() => screen.style.display = 'none', 1200);
                    }, 400);
                }
                fill.style.width = progress + '%';
            }, 50);
        }

        function createStonyTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const context = canvas.getContext('2d');
            context.fillStyle = '#e5e5e5';
            context.fillRect(0, 0, 512, 512);
            for (let i = 0; i < 20000; i++) {
                const x = Math.random() * 512; const y = Math.random() * 512;
                context.fillStyle = `rgba(0,0,0,${Math.random() * 0.05})`;
                context.fillRect(x, y, 1, 1);
            }
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(20, 20);
            return texture;
        }

        function createLightTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const context = canvas.getContext('2d');
            context.fillStyle = '#ffffff';
            context.fillRect(0, 0, 128, 128);
            const texture = new THREE.CanvasTexture(canvas);
            return texture;
        }

        function createBuilding(x, z) {
            const w = 15 + Math.random() * 5;
            const h = 5 + Math.random() * 30;
            const d = 15 + Math.random() * 5;
            const baseGeo = new THREE.BoxGeometry(w, h, d);
            const baseMat = new THREE.MeshPhongMaterial({ map: createLightTexture(), color: 0xffffff });
            const base = new THREE.Mesh(baseGeo, baseMat);
            base.position.set(x, h/2, z);
            base.castShadow = true; base.receiveShadow = true;
            scene.add(base);
            collidableBoxes.push(new THREE.Box3().setFromObject(base));
        }

        function resolveCollisions() {
            const playerBox = new THREE.Box3().setFromCenterAndSize(cameraGroup.position, new THREE.Vector3(playerSize, 2, playerSize));
            for (let box of collidableBoxes) {
                if (playerBox.intersectsBox(box)) {
                    const overlapX = Math.min(playerBox.max.x - box.min.x, box.max.x - playerBox.min.x);
                    const overlapZ = Math.min(playerBox.max.z - box.min.z, box.max.z - playerBox.min.z);
                    if (overlapX < overlapZ) {
                        cameraGroup.position.x += overlapX * (cameraGroup.position.x > (box.min.x + box.max.x) / 2 ? 1 : -1);
                        velocity.x = 0;
                    } else {
                        cameraGroup.position.z += overlapZ * (cameraGroup.position.z > (box.min.z + box.max.z) / 2 ? 1 : -1);
                        velocity.z = 0;
                    }
                    playerBox.setFromCenterAndSize(cameraGroup.position, new THREE.Vector3(playerSize, 2, playerSize));
                }
            }
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf4f4f4);
            scene.fog = new THREE.FogExp2(0xf4f4f4, 0.012);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            cameraGroup = new THREE.Group();
            cameraGroup.add(camera);
            scene.add(cameraGroup);

            const hemiLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 1.8);
            scene.add(hemiLight);
            
            const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
            sunLight.position.set(50, 100, 50);
            sunLight.castShadow = true;
            scene.add(sunLight);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            controls = new PointerLockControls(cameraGroup, document.body);
            document.getElementById('start-btn').onclick = () => controls.lock();
            
            controls.addEventListener('lock', () => {
                document.getElementById('instructions').style.opacity = '0';
                setTimeout(() => document.getElementById('instructions').style.display = 'none', 600);
            });
            
            controls.addEventListener('unlock', () => {
                if (!isInventoryOpen) {
                    document.getElementById('instructions').style.display = 'flex';
                    setTimeout(() => document.getElementById('instructions').style.opacity = '1', 10);
                }
            });

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshPhongMaterial({ map: createStonyTexture() }));
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true; 
            scene.add(floor);

            for (let i = 0; i < 60; i++) {
                createBuilding(Math.random()*300-150, Math.random()*300-150);
            }

            cameraGroup.position.set(0, 5, 0);

            document.addEventListener('keydown', (e) => {
                if (isListeningForKey) {
                    binds[isListeningForKey] = e.code;
                    isListeningForKey = null;
                    refreshKeybindUI();
                    return;
                }
                if (e.code === binds.forward) moveForward = true;
                if (e.code === binds.backward) moveBackward = true;
                if (e.code === binds.left) moveLeft = true;
                if (e.code === binds.right) moveRight = true;
                if (e.code === binds.sprint) isRunning = true;
                if (e.code === binds.jump && canJump) { velocity.y += 22; canJump = false; }
                if (e.code === binds.inventory) toggleInventory();
                
                if (e.code === binds.slide && canJump && !isSliding && slideCooldown <= 0) {
                    isSliding = true; slideTimer = slideMaxDuration; slideCooldown = slideMaxCooldown;
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.code === binds.forward) moveForward = false;
                if (e.code === binds.backward) moveBackward = false;
                if (e.code === binds.left) moveLeft = false;
                if (e.code === binds.right) moveRight = false;
                if (e.code === binds.sprint) isRunning = false;
            });

            setupInventoryLogic();
            setupPauseMenuTabs();
            startLoading();
        }

        function setupPauseMenuTabs() {
            const manualBtn = document.getElementById('tab-manual');
            const bindBtn = document.getElementById('tab-keybinds');
            const manualView = document.getElementById('main-manual');
            const bindView = document.getElementById('keybind-settings');

            manualBtn.onclick = () => {
                manualBtn.classList.add('active');
                bindBtn.classList.remove('active');
                manualView.style.display = 'flex';
                bindView.style.display = 'none';
            };

            bindBtn.onclick = () => {
                bindBtn.classList.add('active');
                manualBtn.classList.remove('active');
                manualView.style.display = 'none';
                bindView.style.display = 'flex';
                refreshKeybindUI();
            };
        }

        function refreshKeybindUI() {
            const container = document.getElementById('keybind-settings');
            container.innerHTML = '';
            for (let action in binds) {
                const row = document.createElement('div');
                row.className = 'key-row';
                row.innerHTML = `<div class="key-label">${action}</div><div class="key-cap ${isListeningForKey === action ? 'listening' : ''}">${binds[action]}</div>`;
                row.querySelector('.key-cap').onclick = () => { isListeningForKey = action; refreshKeybindUI(); };
                container.appendChild(row);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            if (controls.isLocked) {
                velocity.x -= velocity.x * 12.0 * delta;
                velocity.z -= velocity.z * 12.0 * delta;
                velocity.y -= 9.8 * 5.0 * delta; 
                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                const speed = (isRunning && stamina > 0) ? 220.0 : 130.0;
                if (moveForward || moveBackward) velocity.z -= direction.z * speed * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * speed * delta;

                controls.moveForward(-velocity.z * delta);
                controls.moveRight(-velocity.x * delta);
                cameraGroup.position.y += (velocity.y * delta);
                
                if (cameraGroup.position.y < 5) { velocity.y = 0; cameraGroup.position.y = 5; canJump = true; }

                resolveCollisions();
            }
            prevTime = time;
            renderer.render(scene, camera);
        }

        function setupInventoryLogic() {
            const grid = document.getElementById('inv-grid-container');
            for (let i = 0; i < 16; i++) {
                const slot = document.createElement('div');
                slot.className = 'inv-slot';
                grid.appendChild(slot);
            }
            document.getElementById('inv-close-btn').onclick = toggleInventory;
        }

        function toggleInventory() {
            const overlay = document.getElementById('inventory-overlay');
            isInventoryOpen = !isInventoryOpen;
            if (isInventoryOpen) {
                controls.unlock();
                overlay.style.display = 'flex';
                setTimeout(() => overlay.style.opacity = '1', 10);
            } else {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 400);
                controls.lock();
            }
        }

        init();
        animate();
    </script>
</body>
</html>
